version: '3.9'


networks:
  imtihon_net:

services:
  postgres:
      image: postgres:15
      container_name: postgres
      restart: always
      environment:
        POSTGRES_DB: imtihon_db
        POSTGRES_USER: imtihon_user
        POSTGRES_PASSWORD: imtihon_pass
      volumes:
        - postgres_data:/var/lib/postgresql/data
  django:
    build:
      context: ./imtihon_back_crud
    container_name: django_crud
    expose:
      - 8000
    depends_on:
      - fastapi
      - postgres
    networks:
      - imtihon_net
    volumes:
      - static_volume:/app/static
      - media_volume:/app/media
      - ./imtihon_back_crud/:/app/imtihon_back_crud/
    environment:
      
      HOST: imtihon.divspan.uz
      DEBUG: 0
      DB_NAME: imtihon_db
      DB_USER: imtihon_user
      DB_PASSWORD: imtihon_pass
      DB_HOST: postgres
      DB_PORT: 5432
    command: >
      sh -c "python manage.py migrate --noinput &&
             gunicorn core.wsgi:application --workers 4 --bind 0.0.0.0:8000"
  fastapi:
    build:
      context: ./imtihon_back_ai
    container_name: fastapi_ai
    expose:
      - 8001
    networks:
      - imtihon_net
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    depends_on:
      - redis
  celery:
      build:
        context: ./imtihon_back_ai
      container_name: fastapi_celery
      command: celery -A celery_config.tasks worker --loglevel=info
      depends_on:
        - redis
      environment:
        - C_FORCE_ROOT=true
      networks:
        - imtihon_net
      volumes:
        - ./imtihon_back_ai:/app

  redis:
    image: redis:latest
    container_name: redis
    expose:
      - 6379
    networks:
      - imtihon_net
  nginx:
    image: nginx:alpine
    container_name: nginx_proxy
    ports:
      - "85:80"
    networks:
      - imtihon_net

    environment:
      SERVER_NAME: imtihon.divspan.uz
      PORT_NGINX: 80  

  #   volumes:
  #     - ./nginx.conf.template:/etc/nginx/nginx.conf.template:ro
  #     - ./entrypoint.sh:/entrypoint.sh:ro
  #     - static_volume:/app/static
  #     - media_volume:/app/media
  #   depends_on:
  #     - django
  #     - fastapi
  #   command: /bin/sh /entrypoint.sh
  # certbot:
  #   image: certbot/certbot
  #   container_name: certbot
  #   volumes:
  #     - ./certbot/www:/var/www/certbot
  #     - ./certbot/conf:/etc/letsencrypt
  #   command: certonly --webroot --webroot-path=/var/www/certbot --email nigmatovislom3@gmail.com --agree-tos --no-eff-email -d imtihon.divspan.uz
    
volumes:
  static_volume:
  media_volume:
  postgres_data: